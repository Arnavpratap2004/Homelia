// Prisma Schema for Homelia B2B Laminate Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS & AUTHENTICATION
// ============================================

model User {
  id              String    @id @default(uuid())
  role            Role      @default(RETAIL_CUSTOMER)
  email           String    @unique
  phone           String    @unique
  passwordHash    String
  name            String
  companyName     String?
  gstNumber       String?
  panNumber       String?
  stateCode       String?   // For GST calculation
  billingAddress  Json?
  shippingAddress Json?
  creditLimit     Decimal   @default(0) @db.Decimal(12, 2)
  isVerified      Boolean   @default(false)
  isActive        Boolean   @default(true)
  
  refreshToken    String?
  resetToken      String?
  resetTokenExp   DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  orders          Order[]
  quotes          Quote[]
  notifications   Notification[]

  @@index([email])
  @@index([phone])
  @@index([role])
}

enum Role {
  ADMIN
  DEALER
  B2B_CUSTOMER
  RETAIL_CUSTOMER
}

// ============================================
// PRODUCTS CATALOG
// ============================================

model Product {
  id               String    @id @default(uuid())
  name             String
  productCode      String    @unique
  brand            Brand
  category         Category
  collection       String?   // e.g., "Endeavour", "Italia", "Romania"
  finish           Finish
  texture          String    // e.g., "Woodgrain", "Stone", "Solid"
  thickness        String    // e.g., "1mm", "0.8mm"
  sheetSize        String    // e.g., "8x4", "10x4"
  applications     String[]  // ["kitchen", "wardrobe", "furniture"]
  
  price            Decimal?  @db.Decimal(10, 2)
  dealerPrice      Decimal?  @db.Decimal(10, 2)
  b2bPrice         Decimal?  @db.Decimal(10, 2)
  isPriceOnRequest Boolean   @default(false)
  
  hsnCode          String    @default("4823")
  gstRate          Decimal   @default(18) @db.Decimal(5, 2)
  moq              Int       @default(10)
  stockQuantity    Int       @default(0)
  
  images           String[]
  colors           String[]
  description      String?
  technicalSpecs   Json?
  
  isActive         Boolean   @default(true)
  isFeatured       Boolean   @default(false)
  isBestseller     Boolean   @default(false)
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  orderItems       OrderItem[]
  quoteItems       QuoteItem[]

  @@index([brand])
  @@index([category])
  @@index([collection])
  @@index([productCode])
  @@index([isActive])
}

enum Brand {
  DURIAN
  ROCKSTAR
}

enum Category {
  DECORATIVE
  COMPACT
  EXTERIOR
  FIRE_RETARDANT
  ANTI_BACTERIAL
}

enum Finish {
  MATTE
  GLOSSY
  SUEDE
  TEXTURED
  HIGH_GLOSS
  SILK
  METALLIC
}

// ============================================
// ORDERS
// ============================================

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  orderType       OrderType     @default(DIRECT)
  status          OrderStatus   @default(PENDING)
  
  // Pricing
  subtotal        Decimal       @db.Decimal(12, 2)
  cgst            Decimal       @default(0) @db.Decimal(12, 2)
  sgst            Decimal       @default(0) @db.Decimal(12, 2)
  igst            Decimal       @default(0) @db.Decimal(12, 2)
  totalTax        Decimal       @db.Decimal(12, 2)
  freightCharges  Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal       @db.Decimal(12, 2)
  
  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?
  amountPaid      Decimal       @default(0) @db.Decimal(12, 2)
  balanceDue      Decimal       @default(0) @db.Decimal(12, 2)
  
  // Addresses
  shippingAddress Json
  billingAddress  Json
  
  // Reference
  quoteId         String?       @unique
  quote           Quote?        @relation(fields: [quoteId], references: [id])
  notes           String?
  adminNotes      String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  items           OrderItem[]
  invoices        Invoice[]
  payments        Payment[]
  shipments       Shipment[]

  @@index([userId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderNumber])
  @@index([createdAt])
}

enum OrderType {
  DIRECT
  RFQ
  SAMPLE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  INVOICED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  taxRate     Decimal  @default(18) @db.Decimal(5, 2)
  taxAmount   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)

  @@index([orderId])
  @@index([productId])
}

// ============================================
// RFQ / QUOTES
// ============================================

model Quote {
  id             String       @id @default(uuid())
  quoteNumber    String       @unique
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  status         QuoteStatus  @default(REQUESTED)
  
  // Pricing (filled by admin)
  subtotal       Decimal?     @db.Decimal(12, 2)
  totalTax       Decimal?     @db.Decimal(12, 2)
  freightCharges Decimal?     @db.Decimal(10, 2)
  discount       Decimal?     @db.Decimal(10, 2)
  totalAmount    Decimal?     @db.Decimal(12, 2)
  
  validUntil     DateTime?
  notes          String?      // Customer notes
  adminNotes     String?      // Internal notes
  rejectionReason String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  items          QuoteItem[]
  order          Order?

  @@index([userId])
  @@index([status])
  @@index([quoteNumber])
  @@index([createdAt])
}

enum QuoteStatus {
  REQUESTED
  UNDER_REVIEW
  NEGOTIATING
  QUOTED
  APPROVED
  REJECTED
  EXPIRED
  CONVERTED
}

model QuoteItem {
  id           String   @id @default(uuid())
  quoteId      String
  quote        Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  
  requestedQty Int
  quotedQty    Int?
  quotedPrice  Decimal? @db.Decimal(10, 2)
  notes        String?

  @@index([quoteId])
  @@index([productId])
}

// ============================================
// INVOICES (GST COMPLIANT)
// ============================================

model Invoice {
  id              String       @id @default(uuid())
  invoiceNumber   String       @unique
  financialYear   String       // e.g., "2024-25"
  invoiceType     InvoiceType
  orderId         String
  order           Order        @relation(fields: [orderId], references: [id])
  
  // Amounts
  subtotal        Decimal      @db.Decimal(12, 2)
  cgst            Decimal      @default(0) @db.Decimal(12, 2)
  sgst            Decimal      @default(0) @db.Decimal(12, 2)
  igst            Decimal      @default(0) @db.Decimal(12, 2)
  totalTax        Decimal      @db.Decimal(12, 2)
  freightCharges  Decimal      @default(0) @db.Decimal(10, 2)
  discount        Decimal      @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal      @db.Decimal(12, 2)
  
  // Buyer Details
  buyerName       String
  buyerGstin      String?
  buyerStateCode  String?
  buyerAddress    Json
  
  // Seller Details
  sellerGstin     String
  sellerStateCode String
  sellerAddress   Json
  
  // File
  pdfUrl          String?
  
  issuedAt        DateTime     @default(now())
  dueDate         DateTime?
  
  createdAt       DateTime     @default(now())

  @@index([orderId])
  @@index([invoiceNumber])
  @@index([financialYear])
  @@index([issuedAt])
}

enum InvoiceType {
  PROFORMA
  TAX_INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id               String           @id @default(uuid())
  orderId          String
  order            Order            @relation(fields: [orderId], references: [id])
  
  amount           Decimal          @db.Decimal(12, 2)
  paymentMethod    String           // "upi", "card", "netbanking", "bank_transfer"
  
  // Razorpay fields
  gatewayOrderId   String?          // razorpay_order_id
  gatewayPaymentId String?          // razorpay_payment_id
  gatewaySignature String?
  
  transactionId    String?          // For bank transfers
  status           PaymentTxnStatus @default(INITIATED)
  failureReason    String?
  
  paidAt           DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([gatewayOrderId])
}

enum PaymentTxnStatus {
  INITIATED
  PENDING
  SUCCESS
  FAILED
  REFUNDED
  CANCELLED
}

// ============================================
// SHIPMENTS
// ============================================

model Shipment {
  id                String         @id @default(uuid())
  orderId           String
  order             Order          @relation(fields: [orderId], references: [id])
  
  carrier           String?        // "BlueDart", "DTDC", etc.
  trackingNumber    String?
  trackingUrl       String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  status            ShipmentStatus @default(PROCESSING)
  
  weight            Decimal?       @db.Decimal(8, 2) // in kg
  packages          Int            @default(1)
  
  dispatchedAt      DateTime?
  deliveredAt       DateTime?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
}

enum ShipmentStatus {
  PROCESSING
  READY_TO_SHIP
  DISPATCHED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String           @id @default(uuid())
  type          NotificationType
  title         String
  message       String
  data          Json?            // Additional context
  
  recipientId   String?
  recipient     User?            @relation(fields: [recipientId], references: [id])
  recipientRole Role?            // For role-based notifications (e.g., all admins)
  
  isRead        Boolean          @default(false)
  readAt        DateTime?
  
  // For email tracking
  emailSent     Boolean          @default(false)
  emailSentAt   DateTime?
  
  createdAt     DateTime         @default(now())

  @@index([recipientId])
  @@index([recipientRole])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

enum NotificationType {
  NEW_ORDER
  NEW_QUOTE
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  SAMPLE_REQUEST
  ORDER_STATUS_UPDATE
  QUOTE_STATUS_UPDATE
  SHIPMENT_UPDATE
  LOW_STOCK
  USER_REGISTERED
  SYSTEM
}

// ============================================
// SAMPLE REQUESTS
// ============================================

model SampleRequest {
  id             String       @id @default(uuid())
  requestNumber  String       @unique
  
  // Contact
  name           String
  email          String
  phone          String
  companyName    String?
  
  // Address
  address        Json
  
  // Products
  items          Json         // Array of { productId, quantity }
  totalSamples   Int
  
  status         SampleStatus @default(PENDING)
  adminNotes     String?
  
  // Shipping
  shippingCharge Decimal      @default(99) @db.Decimal(8, 2)
  trackingNumber String?
  carrier        String?
  
  shippedAt      DateTime?
  deliveredAt    DateTime?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([email])
  @@index([status])
  @@index([requestNumber])
}

enum SampleStatus {
  PENDING
  APPROVED
  PROCESSING
  SHIPPED
  DELIVERED
  REJECTED
  CANCELLED
}

// ============================================
// SYSTEM
// ============================================

model InvoiceSequence {
  id            String @id @default(uuid())
  financialYear String @unique
  lastNumber    Int    @default(0)
  prefix        String @default("INV")
  
  @@index([financialYear])
}

model OrderSequence {
  id         String @id @default(uuid())
  year       Int    @unique
  lastNumber Int    @default(0)
  prefix     String @default("ORD")
}

model QuoteSequence {
  id         String @id @default(uuid())
  year       Int    @unique
  lastNumber Int    @default(0)
  prefix     String @default("RFQ")
}

model SampleSequence {
  id         String @id @default(uuid())
  year       Int    @unique
  lastNumber Int    @default(0)
  prefix     String @default("SMP")
}
